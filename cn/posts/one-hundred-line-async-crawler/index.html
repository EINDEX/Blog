<!DOCTYPE html>
<html lang="en" class="astro-SCKKX6R4">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" href="/favicon.ico">
    <meta name="generator" content="Astro v2.0.15">
    <title>一百行代码实现异步爬虫</title>
    <link rel="webmention" href="https://webmention.io/eindex.me/webmention">
    <link rel="pingback" href="https://webmention.io/eindex.me/xmlrpc">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link href="https://{{cdn}}/prismjs@v1.x/themes/prism.css" rel="stylesheet">
    <link rel="stylesheet" href="/katex.min.css" crossorigin="anonymous">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SR36ZS0R52"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "G-SR36ZS0R52");
</script>
  <link rel="stylesheet" href="/_astro/gallery.197e1a52.css" />
<link rel="stylesheet" href="/_astro/_slug_.9be3c881.css" />
<link rel="stylesheet" href="/_astro/_slug_.8ced6fc2.css" /><script type="module">class o extends HTMLElement{constructor(){super();const e=this.querySelector("button"),t=this.querySelector("div.code-body");e.addEventListener("click",()=>{navigator.clipboard.writeText(t.innerText).then(()=>{console.log("copy successd")})})}}customElements.define("article-code",o);
</script></head>
  <body class="astro-SCKKX6R4">
    <div class="blog astro-SCKKX6R4">
      <nav class="astro-5BLMO7YK">
  <span class="astro-5BLMO7YK"><img width="32px" height="32px" src="/images/avatar.png" class="astro-5BLMO7YK"><a href="/" class="astro-5BLMO7YK">EINDEX's Blog</a></span>
  <ul class="astro-5BLMO7YK">
    <li class="astro-5BLMO7YK"><a rel="me" href="https://github.com/eindex" class="astro-5BLMO7YK">Github</a></li>
    <li class="astro-5BLMO7YK"><a rel="me" href="https://twitter.com/@eindex_li" class="astro-5BLMO7YK">Twitter</a></li>
  </ul>
</nav>
      <article class="h-entry astro-WMBV4WGB">
    <span class="series p-category astro-WMBV4WGB"></span>
    <h1 class="title p-name astro-WMBV4WGB">
      一百行代码实现异步爬虫<a class="u-url astro-WMBV4WGB" href="/cnone-hundred-line-async-crawler"></a>
    </h1>
    <time class="astro-WMBV4WGB">2019/09/07</time>

    <summary class="p-summary astro-WMBV4WGB"></summary>

    <section class="main e-content astro-WMBV4WGB">
      <p>一个优雅的爬虫需要一下这些东西：</p>
<ul>
<li>请求器</li>
<li>页面解析器</li>
<li>链接生成器</li>
<li>调度器</li>
</ul>
<more></more>
<h2 id="请求器">请求器</h2>
<p>负责发送请求。</p>
<h2 id="页面解析器">页面解析器</h2>
<p>负责从页面上解析出继续爬的链接。</p>
<h2 id="链接生成器">链接生成器</h2>
<p>负责处理继续爬虫的链接并放入队列。</p>
<h2 id="调度器">调度器</h2>
<p>决定链接是否应该被爬去的核心部件。</p>
<h2 id="异步">异步</h2>
<p>同时有多个请求在发送，即时异步爬虫。</p>
<h2 id="代码">代码</h2>
<p>相关代码已上传到 <a href="https://github.com/EINDEX/100-line-async-spider">Github[https://github.com/EINDEX/100-line-async-spider]</a>。</p>
<article-code class="astro-VKVMCQTA">
  <div class="code-header astro-VKVMCQTA">
    <span class="astro-VKVMCQTA">python</span><button class="astro-VKVMCQTA">Copy<svg viewBox="0 0 20 20" class="astro-VKVMCQTA" astro-icon="uiw:copy"><path fill="currentColor" d="M6.644 2.983a.252.252 0 0 0-.253.252c0 .139.113.251.253.251h3.713c.14 0 .253-.112.253-.251a.252.252 0 0 0-.253-.252H6.644zm3.713-1.342c.734 0 1.353.49 1.544 1.16l2.175.001c.621.004 1.122.205 1.432.638.266.372.372.85.345 1.387L15.85 17.84c.042.552-.062 1.04-.328 1.445-.312.473-.821.71-1.452.716H3.14c-.76-.03-1.323-.209-1.675-.609-.327-.371-.47-.88-.464-1.5V4.84c-.013-.6.154-1.106.518-1.48.376-.384.932-.554 1.647-.559h1.935c.19-.67.809-1.16 1.543-1.16h3.713zm0 3.187H6.644c-.546 0-1.027-.27-1.317-.684H3.17c-.383.002-.602.07-.682.152-.091.093-.144.252-.138.531v13.07c-.003.325.052.522.13.61.054.061.286.135.685.151h10.9c.2-.002.28-.04.326-.109.091-.138.133-.334.11-.658l.001-13.096c.014-.293-.027-.482-.096-.578-.026-.035-.116-.072-.336-.073h-2.397c-.29.414-.771.684-1.317.684zM17.2 0c.994 0 1.8.801 1.8 1.79v14.082c0 .988-.806 1.79-1.8 1.79h-1.958v-1.343h1.957c.249 0 .45-.2.45-.447V1.789a.449.449 0 0 0-.45-.447H9.643c-.248 0-.45.2-.45.447v.157h-1.35v-.157C7.843.801 8.649 0 9.643 0H17.2zM8.196 11.751c.373 0 .675.3.675.671 0 .37-.302.671-.675.671H4.145a.673.673 0 0 1-.676-.67c0-.371.303-.672.676-.672h4.051zm4.052-2.684c.372 0 .675.3.675.671 0 .37-.303.671-.675.671H4.145a.673.673 0 0 1-.676-.67c0-.371.303-.672.676-.672h8.103zm0-2.684c.372 0 .675.3.675.671a.673.673 0 0 1-.675.671H4.145a.673.673 0 0 1-.676-.67c0-.371.303-.672.676-.672h8.103z"/></svg></button>
  </div>
  <div class="code-body astro-VKVMCQTA"><pre class="shiki " style="background-color: none" tabindex="0"><code><span class="line"><span style="color: #F92672">import</span><span style="color: #F8F8F2"> aiohttp, asyncio, aiofiles, lxml, pathlib, sys, re, lxml.html</span></span>
<span class="line"><span style="color: #F92672">from</span><span style="color: #F8F8F2"> urllib.parse </span><span style="color: #F92672">import</span><span style="color: #F8F8F2"> urlparse</span></span>
<span class="line"><span style="color: #F92672">from</span><span style="color: #F8F8F2"> pathlib </span><span style="color: #F92672">import</span><span style="color: #F8F8F2"> Path</span></span>
<span class="line"><span style="color: #F92672">from</span><span style="color: #F8F8F2"> hashlib </span><span style="color: #F92672">import</span><span style="color: #F8F8F2"> md5</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AE81FF">MAX_GET</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">MAX_QUEUE_SIZE</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">MAX_WORKER</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">10000</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">100</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">20</span></span>
<span class="line"><span style="color: #F8F8F2">spider_url_set, spider_content_set </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">set</span><span style="color: #F8F8F2">(), </span><span style="color: #66D9EF; font-style: italic">set</span><span style="color: #F8F8F2">()</span></span>
<span class="line"><span style="color: #F8F8F2">status </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> {</span><span style="color: #E6DB74">&quot;success&quot;</span><span style="color: #F8F8F2">: </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">, </span><span style="color: #E6DB74">&quot;all&quot;</span><span style="color: #F8F8F2">: </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">, </span><span style="color: #E6DB74">&quot;same&quot;</span><span style="color: #F8F8F2">: </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">, </span><span style="color: #E6DB74">&quot;same_content&quot;</span><span style="color: #F8F8F2">:</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF; font-style: italic">async</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">fetch</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F; font-style: italic">url</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">global</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">MAX_GET</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">MAX_GET</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">async</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">with</span><span style="color: #F8F8F2"> aiohttp.ClientSession(</span><span style="color: #FD971F; font-style: italic">connector</span><span style="color: #F92672">=</span><span style="color: #F8F8F2">aiohttp.TCPConnector(</span><span style="color: #FD971F; font-style: italic">ssl</span><span style="color: #F92672">=</span><span style="color: #AE81FF">False</span><span style="color: #F8F8F2">), </span><span style="color: #FD971F; font-style: italic">timeout</span><span style="color: #F92672">=</span><span style="color: #F8F8F2">aiohttp.ClientTimeout(</span><span style="color: #FD971F; font-style: italic">total</span><span style="color: #F92672">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)) </span><span style="color: #F92672">as</span><span style="color: #F8F8F2"> session:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">async</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">with</span><span style="color: #F8F8F2"> session.get(url) </span><span style="color: #F92672">as</span><span style="color: #F8F8F2"> response:</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">await</span><span style="color: #F8F8F2"> response.text()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF; font-style: italic">async</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">savefile</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F; font-style: italic">path</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F; font-style: italic">data</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">    path </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> Path(path)</span></span>
<span class="line"><span style="color: #F8F8F2">    path.parent.mkdir(</span><span style="color: #FD971F; font-style: italic">parents</span><span style="color: #F92672">=</span><span style="color: #AE81FF">True</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F; font-style: italic">exist_ok</span><span style="color: #F92672">=</span><span style="color: #AE81FF">True</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">async</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">with</span><span style="color: #F8F8F2"> aiofiles.open(path, </span><span style="color: #FD971F; font-style: italic">mode</span><span style="color: #F92672">=</span><span style="color: #E6DB74">&#39;w&#39;</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">as</span><span style="color: #F8F8F2"> f:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">await</span><span style="color: #F8F8F2"> f.write(data)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">data_analysis</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F; font-style: italic">data</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">try</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">        html </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> lxml.html.fromstring(data)</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> html.xpath(</span><span style="color: #E6DB74">&#39;//a/@href&#39;</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">except</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">url_analysis</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F; font-style: italic">endpoint</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F; font-style: italic">urls</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">for</span><span style="color: #F8F8F2"> url </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> urls:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">not</span><span style="color: #F8F8F2"> url </span><span style="color: #F92672">or</span><span style="color: #F8F8F2"> url </span><span style="color: #F92672">==</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&#39;#&#39;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">or</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&#39;javascript&#39;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> url:</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">continue</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">elif</span><span style="color: #F8F8F2"> url.startswith(</span><span style="color: #E6DB74">&#39;/&#39;</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> endpoint.endswith(</span><span style="color: #E6DB74">&#39;/&#39;</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">                endpoint </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> endpoint[:</span><span style="color: #F92672">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">yield</span><span style="color: #F8F8F2"> endpoint </span><span style="color: #F92672">+</span><span style="color: #F8F8F2"> url</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">elif</span><span style="color: #F8F8F2"> url.endswith(</span><span style="color: #E6DB74">&#39;.html&#39;</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">or</span><span style="color: #F8F8F2"> url.endswith(</span><span style="color: #E6DB74">&#39;.htm&#39;</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">or</span><span style="color: #F8F8F2"> url.endswith(</span><span style="color: #E6DB74">&#39;.shtml&#39;</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">or</span><span style="color: #F8F8F2"> url.endswith(</span><span style="color: #E6DB74">&#39;/&#39;</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">or</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&#39;?&#39;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> url:</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">yield</span><span style="color: #F8F8F2"> url</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">path_gene</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F; font-style: italic">endpoint</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">    result </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> urlparse(endpoint)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">f</span><span style="color: #E6DB74">&#39;data/</span><span style="color: #AE81FF">{</span><span style="color: #E6DB74">&quot;/&quot;</span><span style="color: #F8F8F2">.join(</span><span style="color: #66D9EF; font-style: italic">list</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF">filter</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF; font-style: italic">lambda</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F; font-style: italic">x</span><span style="color: #F8F8F2">:x, result.hostname.split(</span><span style="color: #E6DB74">&quot;.&quot;</span><span style="color: #F8F8F2">)))[::</span><span style="color: #F92672">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">])</span><span style="color: #AE81FF">}{</span><span style="color: #F8F8F2">result.path</span><span style="color: #F92672">+</span><span style="color: #E6DB74">&quot;/index.html&quot;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> result.path</span><span style="color: #F92672">!=</span><span style="color: #E6DB74">&quot;/&quot;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">else</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;/index.html&quot;</span><span style="color: #AE81FF">}{</span><span style="color: #F8F8F2">result.query.replace(</span><span style="color: #E6DB74">&quot;/&quot;</span><span style="color: #F8F8F2">,</span><span style="color: #E6DB74">&quot;&quot;</span><span style="color: #F8F8F2">)</span><span style="color: #AE81FF">}</span><span style="color: #E6DB74">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF; font-style: italic">async</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">pushurl</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F; font-style: italic">url_iter</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F; font-style: italic">queue</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">global</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">MAX_GET</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">try</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">for</span><span style="color: #F8F8F2"> url </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> url_iter:</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">MAX_GET</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&gt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #F92672">await</span><span style="color: #F8F8F2"> queue.put(url)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">except</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">Exception</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">as</span><span style="color: #F8F8F2"> e:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF; font-style: italic">async</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">spider</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F; font-style: italic">name</span><span style="color: #F8F8F2">,</span><span style="color: #FD971F; font-style: italic">queue</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">global</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">MAX_GET</span><span style="color: #F8F8F2">, spider_content_set, spider_url_set</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">while</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">MAX_GET</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&gt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">try</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">            endpoint </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">await</span><span style="color: #F8F8F2"> queue.get()</span></span>
<span class="line"><span style="color: #F8F8F2">            data </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">await</span><span style="color: #F8F8F2"> fetch(endpoint)</span></span>
<span class="line"><span style="color: #F8F8F2">            md5data </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> md5(data.encode()).hexdigest()</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> md5data </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> spider_content_set:</span></span>
<span class="line"><span style="color: #F8F8F2">                status[</span><span style="color: #E6DB74">&#39;same_content&#39;</span><span style="color: #F8F8F2">] </span><span style="color: #F92672">+=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #F92672">continue</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #AE81FF">MAX_GET</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">-=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span></span>
<span class="line"><span style="color: #F8F8F2">            status[</span><span style="color: #E6DB74">&#39;all&#39;</span><span style="color: #F8F8F2">] </span><span style="color: #F92672">+=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span></span>
<span class="line"><span style="color: #F8F8F2">            spider_content_set.add(md5data)</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">await</span><span style="color: #F8F8F2"> savefile(path_gene(endpoint), data)</span></span>
<span class="line"><span style="color: #F8F8F2">            asyncio.gather(asyncio.create_task(pushurl(url_analysis(endpoint, data_analysis(data)), queue)), </span><span style="color: #FD971F; font-style: italic">return_exceptions</span><span style="color: #F92672">=</span><span style="color: #AE81FF">False</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">            status[</span><span style="color: #E6DB74">&#39;success&#39;</span><span style="color: #F8F8F2">] </span><span style="color: #F92672">+=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">except</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">Exception</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">as</span><span style="color: #F8F8F2"> e:</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">pass</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">exit</span><span style="color: #F8F8F2">():</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #66D9EF">print</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">&#39;exit&#39;</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">for</span><span style="color: #F8F8F2"> task </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> asyncio.Task.all_tasks():</span></span>
<span class="line"><span style="color: #F8F8F2">        task.cancel()</span></span>
<span class="line"><span style="color: #F8F8F2">    sys.exit(</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #66D9EF; font-style: italic">async</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">main</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F; font-style: italic">first_endpoint</span><span style="color: #F8F8F2">):</span></span>
<span class="line"><span style="color: #F8F8F2">    queue </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> asyncio.Queue(</span><span style="color: #AE81FF">MAX_QUEUE_SIZE</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">await</span><span style="color: #F8F8F2"> queue.put(first_endpoint)</span></span>
<span class="line"><span style="color: #F8F8F2">    asyncio.gather(</span><span style="color: #F92672">*</span><span style="color: #F8F8F2">[asyncio.create_task(spider(spider_id,queue)) </span><span style="color: #F92672">for</span><span style="color: #F8F8F2"> spider_id </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">range</span><span style="color: #F8F8F2">(</span><span style="color: #AE81FF">MAX_WORKER</span><span style="color: #F8F8F2">)], </span><span style="color: #FD971F; font-style: italic">return_exceptions</span><span style="color: #F92672">=</span><span style="color: #AE81FF">False</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">try</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">while</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">True</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">await</span><span style="color: #F8F8F2"> asyncio.sleep(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #66D9EF">print</span><span style="color: #F8F8F2">(queue.qsize(), </span><span style="color: #AE81FF">MAX_GET</span><span style="color: #F8F8F2">, status)</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">MAX_GET</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">&lt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">or</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">not</span><span style="color: #F8F8F2"> queue.qsize():</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #66D9EF">exit</span><span style="color: #F8F8F2">()</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #F92672">except</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #66D9EF">exit</span><span style="color: #F8F8F2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F92672">if</span><span style="color: #F8F8F2"> __name__ </span><span style="color: #F92672">==</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;__main__&quot;</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">    asyncio.run(main(</span><span style="color: #E6DB74">&#39;https://eindex.me/&#39;</span><span style="color: #F8F8F2">))</span></span>
<span class="line"><span style="color: #F8F8F2">    asyncio.get_event_loop().close()</span></span>
<span class="line"></span></code></pre></div>

  

  
</article-code>
    </section>
  </article>
      <footer class="astro-SZ7XMLTE">  
  <span class="webring astro-MTZRIXCV"> <a href="https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/previous" class="astro-MTZRIXCV">←</a> An IndieWeb Webring 🕸💍 <a href="https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/next" class="astro-MTZRIXCV">→</a> </span>
  <span class="astro-SZ7XMLTE">EINDEX @ 2023</span>
</footer>
    </div>
    <script async defer data-website-id="d963565f-c209-41a4-98d2-faac7625f470" src="https://umami.eindex.me/umami.js"></script>
  

</body></html>