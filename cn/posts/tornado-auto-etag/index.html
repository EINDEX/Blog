<!doctype html><html charset=utf-8 lang=en><head><link href=https://eindex.me/cn/feed.xml rel=alternate title=RSS type=application/rss+xml><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content=EINDEX itemprop=author name=author><title>Tornado Auto Etag 机制 • EINDEX's Blog</title><meta content="Tornado Auto Etag 机制 • EINDEX's Blog" property=og:title><meta charset=utf-8><link href="https://eindex.me/css/index.css?h=caa1bab20dadbcde9c093084650bb9c1581bfa0e25f378fe012c8895a733ada3" rel=stylesheet><style>@-moz-document url-prefix() {.lazy:-moz-loading {visibility:hidden;}}.ieOnly {display: none;}@media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {.ieOnly {display: block;}}</style><link href=https://webmention.io/eindex.me/webmention rel=webmention><link href=https://webmention.io/eindex.me/xmlrpc rel=pingback><script src=https://cdn.jsdelivr.net/npm/iconify-icon@1.0.1/dist/iconify-icon.min.js></script><link href=/favicon-512.png rel=apple-touch-icon sizes=512x512><link href=/favicon-512.png rel=icon sizes=512x512 type=image/png><link href=/favicon-192.png rel=icon sizes=192x192 type=image/png><link href=/manifest.json rel=manifest><meta content=https://eindex.me/cn/posts/tornado-auto-etag/ property=og:url><meta content="EINDEX's Blog" property=og:site_name><meta content=https://eindex.me/images/avatar.png property=og:image><meta content=summary name=twitter:card><meta content="Tornado Auto Etag 机制" name=twitter:title><meta content=@eindex_li name=twitter:site><meta content=@eindex_li name=twitter:creator><meta content=https://eindex.me/images/avatar.png name=twitter:image><script type=application/ld+json>
{
  "@context": "https://schema.org/",
  "@type": "BlogPosting",
  "headline": "Tornado Auto Etag 机制",
  "image": "https://eindex.me/images/avatar.png",
  
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://eindex.me/cn/posts/tornado-auto-etag/"
  },
  
  "datePublished": "2019-04-24",
  
  
  "author": {
    "@type": "Person",
    "name": "EINDEX",
    "url": "https://eindex.me/about"
  },
  "publisher": {
    "@type": "Organization",
    "name": "EINDEX's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://eindex.me/images/avatar.png"
    }
  },
  "keywords": ["Python","Cache","ETag"]
}
</script><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1265138627025369" async crossorigin=anonymous></script><body><div class=all><header><nav class=navbar><div class=avatar><a class=site-link href=https://eindex.me/cn/><img alt=Workflow class=avatar src=https://eindex.me/processed_images/e75389feba7c019600.png></a></div><div class=menus><a href=https://eindex.me/cn/gallery/>相册</a><a href=https://eindex.me/cn/archive/>归档</a></div><div class=switcher><a class="language switch" href=https://eindex.me/><iconify-icon icon=ri:english-input></iconify-icon></a></div></nav></header><div class=content><main><article class=h-entry data-clarity-region=article><section class=header><section class=title-area><h1 class="title p-name"><a class=u-url href=https://eindex.me/cn/posts/tornado-auto-etag/>Tornado Auto Etag 机制</a></h1></section><section class=meta-area><p style="display: none;" class=p-summary>&LTp>为了研究缓存看了 tornado &LTcode>web.py&LT/code> 里的 &LTcode>finish&LT/code> 函数&LT/p></p><span><iconify-icon icon=ant-design:calendar-outlined></iconify-icon> <time class=dt-published>2019-04-24</time></span><span><iconify-icon icon=bx:time-five></iconify-icon> 2 mins</span></section></section><div class="p-author h-card" style="display: none;"><img class="u-logo u-photo" src=https://eindex.me/images/avatar.png><a class="p-nickname p-name u-url" href=https://eindex.me>EINDEX</a><p class=p-note>My goal is make happy.</div><section class="main e-content"><p>为了研究缓存看了 tornado <code>web.py</code> 里的 <code>finish</code> 函数</p><span id=continue-reading></span><p>代码如下<pre class=language-python data-lang=python style=background-color:#272822;color:#f8f8f2;><code class=language-python data-lang=python><span>    </span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>finish</span><span>(</span><span style=font-style:italic;color:#fd971f;>self</span><span>, </span><span style=font-style:italic;color:#fd971f;>chunk</span><span>: Union[</span><span style=font-style:italic;color:#66d9ef;>str</span><span>, </span><span style=font-style:italic;color:#66d9ef;>bytes</span><span>, </span><span style=font-style:italic;color:#66d9ef;>dict</span><span>] </span><span style=color:#f92672;>= </span><span style=color:#ae81ff;>None</span><span>) -> </span><span style=color:#e6db74;>"Future[None]"</span><span>:
</span><span>        </span><span style=color:#75715e;>"""Finishes this response, ending the HTTP request.
</span><span style=color:#75715e;>
</span><span style=color:#75715e;>        Passing a ``chunk`` to ``finish()`` is equivalent to passing that
</span><span style=color:#75715e;>        chunk to ``write()`` and then calling ``finish()`` with no arguments.
</span><span style=color:#75715e;>
</span><span style=color:#75715e;>        Returns a `.Future` which may optionally be awaited to track the sending
</span><span style=color:#75715e;>        of the response to the client. This `.Future` resolves when all the response
</span><span style=color:#75715e;>        data has been sent, and raises an error if the connection is closed before all
</span><span style=color:#75715e;>        data can be sent.
</span><span style=color:#75715e;>
</span><span style=color:#75715e;>        .. versionchanged:: 5.1
</span><span style=color:#75715e;>
</span><span style=color:#75715e;>           Now returns a `.Future` instead of ``None``.
</span><span style=color:#75715e;>        """
</span><span>        </span><span style=color:#f92672;>if </span><span>self._finished:
</span><span>            </span><span style=color:#f92672;>raise </span><span style=font-style:italic;color:#66d9ef;>RuntimeError</span><span>(</span><span style=color:#e6db74;>"finish() called twice"</span><span>)
</span><span>
</span><span>        </span><span style=color:#f92672;>if </span><span>chunk </span><span style=color:#f92672;>is not </span><span style=color:#ae81ff;>None</span><span>:
</span><span>            self.write(chunk)
</span><span>
</span><span>        </span><span style=color:#75715e;># Automatically support ETags and add the Content-Length header if
</span><span>        </span><span style=color:#75715e;># we have not flushed any content yet.
</span><span>        </span><span style=color:#f92672;>if not </span><span>self._headers_written:
</span><span>            </span><span style=color:#f92672;>if </span><span>(
</span><span>                self._status_code </span><span style=color:#f92672;>== </span><span style=color:#ae81ff;>200
</span><span>                </span><span style=color:#f92672;>and </span><span>self.request.method </span><span style=color:#f92672;>in </span><span>(</span><span style=color:#e6db74;>"GET"</span><span>, </span><span style=color:#e6db74;>"HEAD"</span><span>)
</span><span>                </span><span style=color:#f92672;>and </span><span style=color:#e6db74;>"Etag" </span><span style=color:#f92672;>not in </span><span>self._headers
</span><span>            ):
</span><span>                self.set_etag_header()
</span><span>                </span><span style=color:#f92672;>if </span><span>self.check_etag_header():
</span><span>                    self._write_buffer </span><span style=color:#f92672;>= </span><span>[]
</span><span>                    self.set_status(</span><span style=color:#ae81ff;>304</span><span>)
</span><span>            </span><span style=color:#f92672;>if </span><span>self._status_code </span><span style=color:#f92672;>in </span><span>(</span><span style=color:#ae81ff;>204</span><span>, </span><span style=color:#ae81ff;>304</span><span>) </span><span style=color:#f92672;>or </span><span>(
</span><span>                self._status_code </span><span style=color:#f92672;>>= </span><span style=color:#ae81ff;>100 </span><span style=color:#f92672;>and </span><span>self._status_code </span><span style=color:#f92672;>< </span><span style=color:#ae81ff;>200
</span><span>            ):
</span><span>                </span><span style=color:#f92672;>assert not </span><span>self._write_buffer, (
</span><span>                    </span><span style=color:#e6db74;>"Cannot send body with </span><span style=color:#ae81ff;>%s</span><span style=color:#e6db74;>" </span><span style=color:#f92672;>% </span><span>self._status_code
</span><span>                )
</span><span>                self._clear_headers_for_304()
</span><span>            </span><span style=color:#f92672;>elif </span><span style=color:#e6db74;>"Content-Length" </span><span style=color:#f92672;>not in </span><span>self._headers:
</span><span>                content_length </span><span style=color:#f92672;>= </span><span style=color:#66d9ef;>sum</span><span>(</span><span style=color:#66d9ef;>len</span><span>(part) </span><span style=color:#f92672;>for </span><span>part </span><span style=color:#f92672;>in </span><span>self._write_buffer)
</span><span>                self.set_header(</span><span style=color:#e6db74;>"Content-Length"</span><span>, content_length)
</span><span>
</span><span>        </span><span style=color:#f92672;>assert </span><span>self.request.connection </span><span style=color:#f92672;>is not </span><span style=color:#ae81ff;>None
</span><span>        </span><span style=color:#75715e;># Now that the request is finished, clear the callback we
</span><span>        </span><span style=color:#75715e;># set on the HTTPConnection (which would otherwise prevent the
</span><span>        </span><span style=color:#75715e;># garbage collection of the RequestHandler when there
</span><span>        </span><span style=color:#75715e;># are keepalive connections)
</span><span>        self.request.connection.set_close_callback(</span><span style=color:#ae81ff;>None</span><span>)  </span><span style=color:#75715e;># type: ignore
</span><span>
</span><span>        future </span><span style=color:#f92672;>= </span><span>self.flush(</span><span style=font-style:italic;color:#fd971f;>include_footers</span><span style=color:#f92672;>=</span><span style=color:#ae81ff;>True</span><span>)
</span><span>        self.request.connection.finish()
</span><span>        self._log()
</span><span>        self._finished </span><span style=color:#f92672;>= </span><span style=color:#ae81ff;>True
</span><span>        self.on_finish()
</span><span>        self._break_cycles()
</span><span>        </span><span style=color:#f92672;>return </span><span>future
</span></code></pre><p>从代码中可以看出, 满足下面条件的请求:<ul><li><code>self._headers_written</code> 为不为<code>True</code><li>http status 为 <code>200</code> 的 <code>GET</code>、 <code>HEAD</code> 请求<li>同时没有 <code>Etag</code> 在 <code>response header</code> 的情况下</ul><p>tornado 会自动计算返回结果的 sha1, 并设置 Etag 若客户端支持 Etag 机制, 正确返回 <code>If-None-Match</code>, 就能节约一波流量, 美滋滋.</section><section class=post-footer><div class=tags><span class=tag><a href=https://eindex.me/cn/tags/python/>Python</a></span><span class=tag><a href=https://eindex.me/cn/tags/cache/>Cache</a></span><span class=tag><a href=https://eindex.me/cn/tags/etag/>ETag</a></span></div></section></article></main><aside></aside></div><footer class=footer><span class=webring> <a href=https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/previous>←</a> An IndieWeb Webring 🕸💍 <a href=https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/next>→</a> </span><link href=https://github.com/EINDEX rel=me></footer></div>