<!DOCTYPE html>
<html lang="en" class="astro-SCKKX6R4">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" href="/favicon.ico">
    <meta name="generator" content="Astro v2.0.15">
    <title>Tornado Auto Etag 机制</title>
    <link rel="webmention" href="https://webmention.io/eindex.me/webmention">
    <link rel="pingback" href="https://webmention.io/eindex.me/xmlrpc">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link href="https://{{cdn}}/prismjs@v1.x/themes/prism.css" rel="stylesheet">
    <link rel="stylesheet" href="/katex.min.css" crossorigin="anonymous">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SR36ZS0R52"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "G-SR36ZS0R52");
</script>
  <link rel="stylesheet" href="/_astro/gallery.197e1a52.css" />
<link rel="stylesheet" href="/_astro/_slug_.9be3c881.css" />
<link rel="stylesheet" href="/_astro/_slug_.8ced6fc2.css" /><script type="module">class o extends HTMLElement{constructor(){super();const e=this.querySelector("button"),t=this.querySelector("div.code-body");e.addEventListener("click",()=>{navigator.clipboard.writeText(t.innerText).then(()=>{console.log("copy successd")})})}}customElements.define("article-code",o);
</script></head>
  <body class="astro-SCKKX6R4">
    <div class="blog astro-SCKKX6R4">
      <nav class="astro-5BLMO7YK">
  <span class="astro-5BLMO7YK"><img width="32px" height="32px" src="/images/avatar.png" class="astro-5BLMO7YK"><a href="/" class="astro-5BLMO7YK">EINDEX's Blog</a></span>
  <ul class="astro-5BLMO7YK">
    <li class="astro-5BLMO7YK"><a rel="me" href="https://github.com/eindex" class="astro-5BLMO7YK">Github</a></li>
    <li class="astro-5BLMO7YK"><a rel="me" href="https://twitter.com/@eindex_li" class="astro-5BLMO7YK">Twitter</a></li>
  </ul>
</nav>
      <article class="h-entry astro-WMBV4WGB">
    <span class="series p-category astro-WMBV4WGB"></span>
    <h1 class="title p-name astro-WMBV4WGB">
      Tornado Auto Etag 机制<a class="u-url astro-WMBV4WGB" href="/cntornado-auto-etag"></a>
    </h1>
    <time class="astro-WMBV4WGB">2019/04/24</time>

    <summary class="p-summary astro-WMBV4WGB"></summary>

    <section class="main e-content astro-WMBV4WGB">
      <p>为了研究缓存看了 tornado <code>web.py</code> 里的 <code>finish</code> 函数</p>
<more></more>
<p>代码如下</p>
<article-code class="astro-VKVMCQTA">
  <div class="code-header astro-VKVMCQTA">
    <span class="astro-VKVMCQTA">python</span><button class="astro-VKVMCQTA">Copy<svg viewBox="0 0 20 20" class="astro-VKVMCQTA" astro-icon="uiw:copy"><path fill="currentColor" d="M6.644 2.983a.252.252 0 0 0-.253.252c0 .139.113.251.253.251h3.713c.14 0 .253-.112.253-.251a.252.252 0 0 0-.253-.252H6.644zm3.713-1.342c.734 0 1.353.49 1.544 1.16l2.175.001c.621.004 1.122.205 1.432.638.266.372.372.85.345 1.387L15.85 17.84c.042.552-.062 1.04-.328 1.445-.312.473-.821.71-1.452.716H3.14c-.76-.03-1.323-.209-1.675-.609-.327-.371-.47-.88-.464-1.5V4.84c-.013-.6.154-1.106.518-1.48.376-.384.932-.554 1.647-.559h1.935c.19-.67.809-1.16 1.543-1.16h3.713zm0 3.187H6.644c-.546 0-1.027-.27-1.317-.684H3.17c-.383.002-.602.07-.682.152-.091.093-.144.252-.138.531v13.07c-.003.325.052.522.13.61.054.061.286.135.685.151h10.9c.2-.002.28-.04.326-.109.091-.138.133-.334.11-.658l.001-13.096c.014-.293-.027-.482-.096-.578-.026-.035-.116-.072-.336-.073h-2.397c-.29.414-.771.684-1.317.684zM17.2 0c.994 0 1.8.801 1.8 1.79v14.082c0 .988-.806 1.79-1.8 1.79h-1.958v-1.343h1.957c.249 0 .45-.2.45-.447V1.789a.449.449 0 0 0-.45-.447H9.643c-.248 0-.45.2-.45.447v.157h-1.35v-.157C7.843.801 8.649 0 9.643 0H17.2zM8.196 11.751c.373 0 .675.3.675.671 0 .37-.302.671-.675.671H4.145a.673.673 0 0 1-.676-.67c0-.371.303-.672.676-.672h4.051zm4.052-2.684c.372 0 .675.3.675.671 0 .37-.303.671-.675.671H4.145a.673.673 0 0 1-.676-.67c0-.371.303-.672.676-.672h8.103zm0-2.684c.372 0 .675.3.675.671a.673.673 0 0 1-.675.671H4.145a.673.673 0 0 1-.676-.67c0-.371.303-.672.676-.672h8.103z"/></svg></button>
  </div>
  <div class="code-body astro-VKVMCQTA"><pre class="shiki " style="background-color: none" tabindex="0"><code><span class="line"><span style="color: #F8F8F2">    </span><span style="color: #66D9EF; font-style: italic">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">finish</span><span style="color: #F8F8F2">(</span><span style="color: #FD971F; font-style: italic">self</span><span style="color: #F8F8F2">, </span><span style="color: #FD971F; font-style: italic">chunk</span><span style="color: #F8F8F2">: Union[</span><span style="color: #66D9EF; font-style: italic">str</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF; font-style: italic">bytes</span><span style="color: #F8F8F2">, </span><span style="color: #66D9EF; font-style: italic">dict</span><span style="color: #F8F8F2">] </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">None</span><span style="color: #F8F8F2">) -&gt; </span><span style="color: #E6DB74">&quot;Future[None]&quot;</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #E6DB74">&quot;&quot;&quot;Finishes this response, ending the HTTP request.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6DB74">        Passing a ``chunk`` to ``finish()`` is equivalent to passing that</span></span>
<span class="line"><span style="color: #E6DB74">        chunk to ``write()`` and then calling ``finish()`` with no arguments.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6DB74">        Returns a `.Future` which may optionally be awaited to track the sending</span></span>
<span class="line"><span style="color: #E6DB74">        of the response to the client. This `.Future` resolves when all the response</span></span>
<span class="line"><span style="color: #E6DB74">        data has been sent, and raises an error if the connection is closed before all</span></span>
<span class="line"><span style="color: #E6DB74">        data can be sent.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6DB74">        .. versionchanged:: 5.1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E6DB74">           Now returns a `.Future` instead of ``None``.</span></span>
<span class="line"><span style="color: #E6DB74">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._finished:</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">raise</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF; font-style: italic">RuntimeError</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">&quot;finish() called twice&quot;</span><span style="color: #F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> chunk </span><span style="color: #F92672">is</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">not</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">None</span><span style="color: #F8F8F2">:</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.write(chunk)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #88846F"># Automatically support ETags and add the Content-Length header if</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #88846F"># we have not flushed any content yet.</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">not</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._headers_written:</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._status_code </span><span style="color: #F92672">==</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">200</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #F92672">and</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.request.method </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> (</span><span style="color: #E6DB74">&quot;GET&quot;</span><span style="color: #F8F8F2">, </span><span style="color: #E6DB74">&quot;HEAD&quot;</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #F92672">and</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;Etag&quot;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">not</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._headers</span></span>
<span class="line"><span style="color: #F8F8F2">            ):</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.set_etag_header()</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.check_etag_header():</span></span>
<span class="line"><span style="color: #F8F8F2">                    </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._write_buffer </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> []</span></span>
<span class="line"><span style="color: #F8F8F2">                    </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.set_status(</span><span style="color: #AE81FF">304</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._status_code </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> (</span><span style="color: #AE81FF">204</span><span style="color: #F8F8F2">, </span><span style="color: #AE81FF">304</span><span style="color: #F8F8F2">) </span><span style="color: #F92672">or</span><span style="color: #F8F8F2"> (</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._status_code </span><span style="color: #F92672">&gt;=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">100</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">and</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._status_code </span><span style="color: #F92672">&lt;</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">200</span></span>
<span class="line"><span style="color: #F8F8F2">            ):</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #F92672">assert</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">not</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._write_buffer, (</span></span>
<span class="line"><span style="color: #F8F8F2">                    </span><span style="color: #E6DB74">&quot;Cannot send body with </span><span style="color: #AE81FF">%s</span><span style="color: #E6DB74">&quot;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">%</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._status_code</span></span>
<span class="line"><span style="color: #F8F8F2">                )</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._clear_headers_for_304()</span></span>
<span class="line"><span style="color: #F8F8F2">            </span><span style="color: #F92672">elif</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;Content-Length&quot;</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">not</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._headers:</span></span>
<span class="line"><span style="color: #F8F8F2">                content_length </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #66D9EF">sum</span><span style="color: #F8F8F2">(</span><span style="color: #66D9EF">len</span><span style="color: #F8F8F2">(part) </span><span style="color: #F92672">for</span><span style="color: #F8F8F2"> part </span><span style="color: #F92672">in</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._write_buffer)</span></span>
<span class="line"><span style="color: #F8F8F2">                </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.set_header(</span><span style="color: #E6DB74">&quot;Content-Length&quot;</span><span style="color: #F8F8F2">, content_length)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">assert</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.request.connection </span><span style="color: #F92672">is</span><span style="color: #F8F8F2"> </span><span style="color: #F92672">not</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">None</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #88846F"># Now that the request is finished, clear the callback we</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #88846F"># set on the HTTPConnection (which would otherwise prevent the</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #88846F"># garbage collection of the RequestHandler when there</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #88846F"># are keepalive connections)</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.request.connection.set_close_callback(</span><span style="color: #AE81FF">None</span><span style="color: #F8F8F2">)  </span><span style="color: #88846F"># type: ignore</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">        future </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.flush(</span><span style="color: #FD971F; font-style: italic">include_footers</span><span style="color: #F92672">=</span><span style="color: #AE81FF">True</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.request.connection.finish()</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._log()</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._finished </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">True</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">.on_finish()</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #FD971F">self</span><span style="color: #F8F8F2">._break_cycles()</span></span>
<span class="line"><span style="color: #F8F8F2">        </span><span style="color: #F92672">return</span><span style="color: #F8F8F2"> future</span></span>
<span class="line"></span></code></pre></div>

  

  
</article-code>
<p>从代码中可以看出, 满足下面条件的请求:</p>
<ul>
<li><code>self._headers_written</code> 为不为<code>True</code></li>
<li>http status 为 <code>200</code> 的 <code>GET</code>、 <code>HEAD</code> 请求</li>
<li>同时没有 <code>Etag</code> 在 <code>response header</code> 的情况下</li>
</ul>
<p>tornado 会自动计算返回结果的 sha1, 并设置 Etag 若客户端支持 Etag 机制, 正确返回 <code>If-None-Match</code>, 就能节约一波流量, 美滋滋.</p>
    </section>
  </article>
      <footer class="astro-SZ7XMLTE">  
  <span class="webring astro-MTZRIXCV"> <a href="https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/previous" class="astro-MTZRIXCV">←</a> An IndieWeb Webring 🕸💍 <a href="https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/next" class="astro-MTZRIXCV">→</a> </span>
  <span class="astro-SZ7XMLTE">EINDEX @ 2023</span>
</footer>
    </div>
    <script async defer data-website-id="d963565f-c209-41a4-98d2-faac7625f470" src="https://umami.eindex.me/umami.js"></script>
  

</body></html>