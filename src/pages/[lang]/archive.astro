---
import Layout from "@layouts/Layout.astro";
import { getPosts } from "@utils/posts";
import { getLastPartOfSlug, getLinkViaLocale } from "@utils/slug";

import _ from "lodash";

import { useTranslations } from "@i18n/utils";

export const prerender = true;

export function getStaticPaths() {
  return [{ params: { lang: "en" } }, { params: { lang: "zh" } }];
}

const { lang } = Astro.params;

const t = useTranslations(lang);

const locale = lang;

const posts = await getPosts(lang);
const groupedPosts = _.groupBy(posts, (post) => post.data.date.getFullYear());
const sortedPostGroupKeys = Object.keys(groupedPosts).sort((a, b) => {
  return groupedPosts[a][0].data.date < groupedPosts[b][0].data.date ? 1 : -1;
});
---

<Layout title={t("common.archive")}>
  <article>
    <h1>{t("common.archive")}</h1>
    <section>
      <div class="posts">
        {
          sortedPostGroupKeys.map((month) => (
            <div class="posts-in-month">
              <h2>
                {groupedPosts[month][0].data.date.getFullYear()}
              </h2>
              <ul>
                {groupedPosts[month].map((post) => (
                  <li>
                    <a
                      class="post"
                      href={getLinkViaLocale(
                        locale,
                        `/posts/${getLastPartOfSlug(post.slug)}`
                      )}
                    >
                      {post.data.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))
        }
      </div>
    </section>
  </article>
</Layout>

<style lang="scss">
  article {
    @apply flex flex-col w-full gap-4;

    img {
      @apply w-full rounded-lg top-8 -z-10;
    }
    h1 {
      @apply text-3xl font-bold text-center;
    }
    .posts-in-month > h2 {
      @apply text-xl my-2;
    }

    ul {
      @apply list-disc list-inside;
      li {
        @apply ml-2;
      }
    }
  }
</style>
