---
import { CollectionEntry } from "astro:content";
import i18next, { changeLanguage, t } from "i18next";
import Layout from "@layouts/Layout.astro";
import { getThoughts } from "@utils/posts";
import { timeFormat } from "@utils/time";
import Breadcrumb from "@components/Breadcrumb.astro";
import Comments from "@components/Comments.astro";
import Tags from "@components/Tags.astro";
import { getLastPartOfSlug, getLinkViaLocale } from "@utils/slug";
import ReplyA from "@components/webmentions/ReplyA.astro";

changeLanguage("en");

const locale = i18next.language;
export async function getStaticPaths() {
  const locale = i18next.language;
  const thoughts = await getThoughts(locale);
  return thoughts.map((thought) => {
    const slug = getLastPartOfSlug(thought.slug);
    return {
      params: { slug: slug },
      props: { thought },
    };
  });
}
type Props = CollectionEntry<`thoughts`>;
const { slug } = Astro.params;
const { thought } = Astro.props;
const { Content } = await thought.render();
---

<Layout
  title={t("thoughts")}
  seo={{
    title: t("thoughts"),
    description: thought.body,
    url: `/thoughts/${slug}`,
    date: thought.data.date,
    updated: thought.data.updated,
    keywords: thought.data.tags,
  }}
>
  <Breadcrumb
    breadcrumb={[
      {
        url: `/thoughts`,
        name: "thoughts",
      },
    ]}
  />
  <article class="h-entry">
    <h1 class="series p-name p-category">{t("thoughts")}</h1>
    <a class="u-url" href={getLinkViaLocale(locale, `/thoughts/${slug}`)}></a>
    <a
      rel="author"
      style="display: none;"
      class="p-author h-card"
      href="https://eindex.me/"
      ><img
        class="u-photo"
        src="https://eindex.me/images/avatar.png"
      />EINDEX</a
    >
    <div class="post-meta">
      <time class="dt-updated" datetime={thought.data.updated.toISOString()}
        >{timeFormat(thought.data.updated, locale)}</time
      >
      <time class="dt-published" datetime={thought.data.date.toISOString()}
      ></time>
      <time class="dt-deleted" datetime={new Date().toISOString()}></time>
    </div>
    <section
      class="main title e-content p-summary format sm:format-sm lg:format-lg dark:format-invert format-pre:m-0 format-pre:p-2 format-li:list-disc list-disc"
    >
      <Content components={{ a: ReplyA, link: ReplyA }} />
    </section>
    <Tags tags={thought.data.tags} />
  </article>

  <Comments locale={locale} slug={`/thoughts/${slug}`} />
</Layout>

<style lang="scss">
  article {
    @apply flex flex-col w-full gap-4;

    img {
      @apply w-full rounded-lg top-8 -z-10;
    }
    h1 {
      @apply text-3xl font-bold text-center;
    }

    .post-meta {
      @apply flex flex-col gap-2;
      color: var(--text-color);

      time {
        @apply text-left;
      }
    }
    section.main.e-content {
      @apply max-w-full list-disc;
      color: var(--text-color);
      background-color: var(--bg-color);
    }

    .labels {
      @apply flex flex-row flex-wrap text-sm gap-2 justify-center;

      .tag {
        @apply rounded-sm px-2 bg-gray-300 dark:bg-gray-700;
        background-color: var(--label-background-color);
      }
    }
  }
</style>
